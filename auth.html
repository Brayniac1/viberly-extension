<!DOCTYPE html>
<meta charset="utf-8" />
<title>Signing you in…</title>
<body style="background: #0f1116; color: #e5e7eb; font: 13px system-ui">
  Signing you in…
</body>
<script defer src="vendor/browser-polyfill.js"></script>

<script>
  // 1) Tell background to finish auth (state check + set session)
  browser.runtime
    .sendMessage({
      type: "AUTH_REDIRECT",
      redirectUrl: location.href,
    })
    .then(() => {
      // 2) Try to return focus to the tab the user came from
      browser.storage.local.get("__vg_return_to").then((bag) => {
        const rt = bag && bag.__vg_return_to;
        // Clean up this key no matter what
        try {
          browser.storage.local.remove("__vg_return_to");
        } catch {}

        if (rt && (rt.tabId || rt.url)) {
          try {
            // If the original tab still exists, activate it and focus its window
            browser.tabs.get(rt.tabId).then((tab) => {
              if (browser.runtime.lastError || !tab) {
                // Tab is gone — reopen the saved URL if we have one
                if (rt.url) browser.tabs.create({ url: rt.url });
              } else {
                browser.tabs.update(rt.tabId, { active: true });
                if (tab.windowId)
                  browser.windows.update(tab.windowId, { focused: true });
              }
            });
          } catch {}
        }
      });

      // 3) Give BG a moment to process, then close THIS auth tab
      setTimeout(() => {
        try {
          window.close();
        } catch {}
        try {
          browser.tabs.getCurrent().then((tab) => {
            if (tab?.id) browser.tabs.remove(tab.id);
          });
        } catch {}
      }, 300);
    });
</script>
